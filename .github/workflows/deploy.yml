name: Deploy app

on:
  workflow_dispatch:

jobs:
  Disable_TG1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Disable TG1 Traffic
        env:
          traffic: 2
        run: python3 DNS_Failover.py

  approval_gate:
    needs: Disable_TG1
    runs-on: ubuntu-latest
    environment:
      name: Deploy
    steps:
      - run: echo "Waiting for approval..."
  
  deploy_server1:
    needs: approval_gate
    runs-on: ubuntu-latest
    env:
      SSH_USER: ubuntu
      SERVERS_JSON_PATH: servers.json
      REMOTE_DIR: python-app
      LOCAL_SCRIPT: app.py

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install runner tools
        run: sudo apt-get update -y && sudo apt-get install -y jq rsync openssh-client

      - name: Write SSH key
        run: |
          if [ -z "${{ secrets.EC2_SSHKEY }}" ]; then
            echo "ERROR: EC2_SSHKEY secret is empty"
            exit 1
          fi
          echo "${{ secrets.EC2_SSHKEY }}" | sed 's/\r$//' > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Validate files
        run: |
          if [ ! -f "$SERVERS_JSON_PATH" ]; then
            echo "ERROR: $SERVERS_JSON_PATH not found"
            ls -la
            exit 1
          fi
          if [ ! -f "$LOCAL_SCRIPT" ]; then
            echo "ERROR: $LOCAL_SCRIPT not found"
            ls -la
            exit 1
          fi
          jq -r '.servers[]' "$SERVERS_JSON_PATH"

      - name: Copy app.py and install flask + run nohup (no noninteractive)
        env:
          SSH_USER: ${{ env.SSH_USER }}
          SERVERS_JSON_PATH: ${{ env.SERVERS_JSON_PATH }}
          REMOTE_DIR: ${{ env.REMOTE_DIR }}
          LOCAL_SCRIPT: ${{ env.LOCAL_SCRIPT }}
        run: |
          ip=$(jq -r 'if (.servers | type) == "object" then .servers.DC1 elif (.servers | type) == "array" then (.servers[] | select(has("DC1")) | .DC1) else empty end' "$SERVERS_JSON_PATH")

          if [ -z "$ip" ] || [ "$ip" = "null" ]; then
              echo "❌ DC1 IP not found in $SERVERS_JSON_PATH. Expected either {\"servers\": {\"DC1\": \"ip\", ...}} or {\"servers\": [{\"DC1\":\"ip\"}, ...]}"
            exit 1
          fi
            echo "---- Processing $ip ----"

            # ensure remote directory exists
            ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" "mkdir -p ~/${REMOTE_DIR}" || {
              echo "❌ Could not create remote directory on $ip; skipping"
              continue
            }

            # copy app.py
            echo "Copying ${LOCAL_SCRIPT} to ${ip}:~/${REMOTE_DIR}/"
            rsync -az -e "ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ec2_key.pem" "$LOCAL_SCRIPT" "${SSH_USER}@${ip}:~/${REMOTE_DIR}/" || {
              echo "❌ rsync failed for $ip; skipping"
              continue
            }

            echo "Running remote install and start commands on $ip ..."
            ssh -o BatchMode=yes -o ConnectTimeout=20 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" bash -lc $'
              set -e
              echo "Updating apt..."
              sudo apt-get update -y
              echo "Installing python3-flask..."
              sudo apt-get install -y python3-flask
              sudo fuser -k 5000/tcp || true

              cd ~/'"${REMOTE_DIR}"' || { echo "ERROR: cannot cd to ~/'"${REMOTE_DIR}"'"; exit 2; }

              echo "Starting '"${LOCAL_SCRIPT}"' with nohup..."
              nohup python3 '"${LOCAL_SCRIPT}"' > output.log 2>&1 &

              sleep 2
              if pgrep -f "python3 '"${LOCAL_SCRIPT}"'" >/dev/null 2>&1; then
                echo "✅ ${LOCAL_SCRIPT} started on $(hostname)"
                tail -n 8 output.log || true
              else
                echo "⚠️ ${LOCAL_SCRIPT} did not remain running on $(hostname) (check output.log)"
                tail -n 40 output.log || true
                exit 3
              fi
            ' 2>&1 | sed "s/^/[${ip}] /"

            rc=${PIPESTATUS[0]}
            if [ $rc -eq 0 ]; then
              echo "✅ Remote commands succeeded on $ip"
            else
              echo "❌ Remote commands failed on $ip (exit $rc)"
            fi
          done

      - name: Cleanup SSH key
        if: always()
        run: |
          shred -u ec2_key.pem || rm -f ec2_key.pem
