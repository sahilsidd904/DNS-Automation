name: Blue/Green-style rollout (TG2 -> server1 -> TG1 -> server2 -> 50/50)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  # Replace these with your real ARNs or set as repository secrets and reference them.
  AWS_REGION: ap-southeast-2
  LISTENER_ARN: arn:aws:elasticloadbalancing:ap-southeast-2:820345161521:listener/app/DNSAutomation/3be55bd9e1ec10c0/8b88ad7fa84aa985
  TG1_ARN: arn:aws:elasticloadbalancing:ap-southeast-2:820345161521:targetgroup/Targetgroup1/356f9014e7004059
  TG2_ARN: arn:aws:elasticloadbalancing:ap-southeast-2:820345161521:targetgroup/Targetgroup2/0f48205b9cf739c7

jobs:
  rollout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install runner tools
        run: sudo apt-get update -y && sudo apt-get install -y jq python3-pip openssh-client rsync curl

      - name: Install boto3
        run: python3 -m pip install --upgrade pip boto3

      - name: Write SSH key
        run: |
          echo "${{ secrets.EC2_SSHKEY }}" | sed 's/\r$//' > ec2_key.pem
          chmod 600 ec2_key.pem

      - name: Read servers (server1, server2)
        id: servers
        run: |
          if [ ! -f servers.json ]; then
            echo "servers.json not found"
            exit 1
          fi
          mapfile -t IPS < <(jq -r '.servers[]' servers.json)
          if [ ${#IPS[@]} -lt 2 ]; then
            echo "Need at least two servers in servers.json"
            exit 1
          fi
          echo "server1=${IPS[0]}" >> $GITHUB_OUTPUT
          echo "server2=${IPS[1]}" >> $GITHUB_OUTPUT

      - name: Route 100% → TG2
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          LISTENER_ARN: ${{ env.LISTENER_ARN }}
          TG1_ARN: ${{ env.TG1_ARN }}
          TG2_ARN: ${{ env.TG2_ARN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          python3 - <<PY
import boto3, os, sys
region=os.getenv('AWS_REGION')
client=boto3.client('elbv2', region_name=region)
listener_arn=os.getenv('LISTENER_ARN')
tg1=os.getenv('TG1_ARN')
tg2=os.getenv('TG2_ARN')
print("Routing 100% -> TG2")
resp=client.modify_listener(
  ListenerArn=listener_arn,
  DefaultActions=[{
    "Type":"forward",
    "ForwardConfig":{"TargetGroups":[{"TargetGroupArn":tg1,"Weight":0},{"TargetGroupArn":tg2,"Weight":1}]}
  }]
)
print("modify_listener response:", resp)
PY

      - name: Deploy to server1 (first IP)
        env:
          SSH_USER: ubuntu
          REMOTE_DIR: python-app
          LOCAL_SCRIPT: app.py
          SERVER_IP: ${{ steps.servers.outputs.server1 }}
        run: |
          ip="${SERVER_IP}"
          echo "Deploying to server1 (${ip})"
          # ensure remote dir
          ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" "mkdir -p ~/${REMOTE_DIR}" || { echo "ssh mkdir failed"; exit 2; }
          # copy app.py
          rsync -az -e "ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ec2_key.pem" "${LOCAL_SCRIPT}" "${SSH_USER}@${ip}:~/${REMOTE_DIR}/" || { echo "rsync failed"; exit 3; }
          # install flask via apt and start app (does NOT stop existing apps)
          ssh -o BatchMode=yes -o ConnectTimeout=20 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" bash -lc $'
            set -e
            echo "sudo apt-get update..."
            sudo apt-get update -y
            echo "sudo apt-get install python3-flask..."
            sudo apt-get install -y python3-flask
            cd ~/'"${REMOTE_DIR}"'
            nohup python3 '"${LOCAL_SCRIPT}"' > output.log 2>&1 &
            sleep 2
            if pgrep -f "python3 '"${LOCAL_SCRIPT}"'" >/dev/null; then
              echo "STARTED_OK"
              exit 0
            else
              echo "START_FAILED"
              tail -n 50 output.log || true
              exit 4
            fi
          '
      
      - name: Route 100% → TG1
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          LISTENER_ARN: ${{ env.LISTENER_ARN }}
          TG1_ARN: ${{ env.TG1_ARN }}
          TG2_ARN: ${{ env.TG2_ARN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          python3 - <<PY
import boto3, os
region=os.getenv('AWS_REGION')
client=boto3.client('elbv2', region_name=region)
listener_arn=os.getenv('LISTENER_ARN')
tg1=os.getenv('TG1_ARN'); tg2=os.getenv('TG2_ARN')
print("Routing 100% -> TG1")
resp=client.modify_listener(
  ListenerArn=listener_arn,
  DefaultActions=[{
    "Type":"forward",
    "ForwardConfig":{"TargetGroups":[{"TargetGroupArn":tg1,"Weight":1},{"TargetGroupArn":tg2,"Weight":0}]}
  }]
)
print("modify_listener response:", resp)
PY

      - name: Deploy to server2 (second IP)
        env:
          SSH_USER: ubuntu
          REMOTE_DIR: python-app
          LOCAL_SCRIPT: app.py
          SERVER_IP: ${{ steps.servers.outputs.server2 }}
        run: |
          ip="${SERVER_IP}"
          echo "Deploying to server2 (${ip})"
          ssh -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" "mkdir -p ~/${REMOTE_DIR}" || { echo "ssh mkdir failed"; exit 2; }
          rsync -az -e "ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i ec2_key.pem" "${LOCAL_SCRIPT}" "${SSH_USER}@${ip}:~/${REMOTE_DIR}/" || { echo "rsync failed"; exit 3; }
          ssh -o BatchMode=yes -o ConnectTimeout=20 -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" bash -lc $'
            set -e
            sudo apt-get update -y
            sudo apt-get install -y python3-flask
            cd ~/'"${REMOTE_DIR}"'
            nohup python3 '"${LOCAL_SCRIPT}"' > output.log 2>&1 &
            sleep 2
            if pgrep -f "python3 '"${LOCAL_SCRIPT}"'" >/dev/null; then
              echo "STARTED_OK"
              exit 0
            else
              echo "START_FAILED"
              tail -n 50 output.log || true
              exit 4
            fi
          '

      - name: Route 50/50 between TG1 and TG2
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          LISTENER_ARN: ${{ env.LISTENER_ARN }}
          TG1_ARN: ${{ env.TG1_ARN }}
          TG2_ARN: ${{ env.TG2_ARN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
        run: |
          python3 - <<PY
import boto3, os
region=os.getenv('AWS_REGION')
client=boto3.client('elbv2', region_name=region)
listener_arn=os.getenv('LISTENER_ARN')
tg1=os.getenv('TG1_ARN'); tg2=os.getenv('TG2_ARN')
print("Routing 50/50 between TG1 and TG2")
resp=client.modify_listener(
  ListenerArn=listener_arn,
  DefaultActions=[{
    "Type":"forward",
    "ForwardConfig":{"TargetGroups":[{"TargetGroupArn":tg1,"Weight":1},{"TargetGroupArn":tg2,"Weight":1}]}
  }]
)
print("modify_listener response:", resp)
PY

      - name: Cleanup SSH key
        if: always()
        run: rm -f ec2_key.pem
