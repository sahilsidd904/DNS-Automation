name: Deploy app.py to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: SSH into EC2 and run app.py
        env:
          SSH_USER: ${{ secrets.EC2_SSH_USER }}
          EC2_KEY: ${{ secrets.EC2_SSHKEY }}
        run: |
          echo "$EC2_KEY" | sed 's/\r$//' > ec2_key.pem
          chmod 600 ec2_key.pem

          mapfile -t IPS < <(jq -r '.servers[]' servers.json)

          for ip in "${IPS[@]}"; do
            echo "Deploying to $ip ..."

            ssh -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" <<'EOF'
              pkill -f "python3 app.py" || true
              mkdir -p ~/python-app
              cd ~/python-app
              nohup python3 app.py > output.log 2>&1 &
              if [ $? -eq 0 ]; then
                echo "✅ Successfully started app.py on $(hostname)"
              else
                echo "❌ Failed to start app.py on $(hostname)"
              fi
EOF

            if [ $? -eq 0 ]; then
              echo "✅ Deployment succeeded on $ip"
            else
              echo "❌ Deployment failed on $ip"
            fi
          done

          rm -f ec2_key.pem
