name: Deploy Python script to EC2 (verbose + logs)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

env:
  SERVERS_JSON_PATH: "servers.json"
  REMOTE_APP_DIR: "python-app"
  LOCAL_START_SCRIPT: "app.py"   # change to your .py filename if desired
  LOGS_DIR: "remote-logs"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install utilities (jq, rsync, ssh)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq rsync openssh-client
        shell: bash

      - name: Validate secrets exist
        run: |
          if [ -z "${{ secrets.EC2_SSHKEY }}" ]; then
            echo "ERROR: EC2_SSHKEY secret is empty. Add the PEM contents as repo secret."
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_USER }}" ]; then
            echo "ERROR: EC2_SSH_USER secret is empty. Add the SSH user (ec2-user/ubuntu/etc)."
            exit 1
          fi
        shell: bash

      - name: Write SSH key file (strip CRLF and secure permissions)
        run: |
          echo "${{ secrets.EC2_SSHKEY }}" | sed 's/\r$//' > ec2_key.pem
          chmod 600 ec2_key.pem
        shell: bash

      - name: Validate servers.json and show parsed IPs
        run: |
          if [ ! -f "$SERVERS_JSON_PATH" ]; then
            echo "ERROR: $SERVERS_JSON_PATH not found in repo root."
            ls -la
            exit 1
          fi
          echo "servers.json:"
          cat "$SERVERS_JSON_PATH"
          echo "Parsed IPs:"
          jq -r '.servers[]' "$SERVERS_JSON_PATH"
        shell: bash

      - name: SSH connectivity quick test (non-fatal)
        env:
          SSH_USER: ${{ secrets.EC2_SSH_USER }}
        run: |
          SSH_USER="${SSH_USER:-ec2-user}"
          mapfile -t IPS < <(jq -r '.servers[]' "$SERVERS_JSON_PATH")
          if [ ${#IPS[@]} -eq 0 ]; then
            echo "No IPs found in $SERVERS_JSON_PATH"
            exit 1
          fi
          for ip in "${IPS[@]}"; do
            echo "---- Connectivity test to $ip ----"
            # Try a simple SSH command (BatchMode=yes avoids prompt)
            ssh -i ec2_key.pem -o BatchMode=yes -o ConnectTimeout=10 -o StrictHostKeyChecking=no "${SSH_USER}@${ip}" "echo SSH_OK" \
              && echo "$ip: SSH_OK" || echo "$ip: SSH_FAILED (check key/user/network/security-group)"
          done
        shell: bash

      - name: Deploy to EC2 servers (verbose start + fetch logs)
        env:
          SSH_USER: ${{ secrets.EC2_SSH_USER }}
          SERVERS_JSON_PATH: ${{ env.SERVERS_JSON_PATH }}
          REMOTE_APP_DIR: ${{ env.REMOTE_APP_DIR }}
          LOCAL_START_SCRIPT: ${{ env.LOCAL_START_SCRIPT }}
          LOGS_DIR: ${{ env.LOGS_DIR }}
        run: |
          SSH_USER="${SSH_USER:-ec2-user}"
          mkdir -p "$LOGS_DIR"

          mapfile -t IPS < <(jq -r '.servers[]' "$SERVERS_JSON_PATH")
          if [ ${#IPS[@]} -eq 0 ]; then
            echo "No IPs found; aborting."
            exit 1
          fi

          for ip in "${IPS[@]}"; do
            safe_ip="${ip//./-}"   # e.g., 12.34.56.78 -> 12-34-56-78
            echo
            echo "================== Deploying to $ip =================="
            # create remote dir
            echo "Creating remote dir ~/${REMOTE_APP_DIR}..."
            ssh -o StrictHostKeyChecking=no -i ec2_key.pem "${SSH_USER}@${ip}" "mkdir -p ~/${REMOTE_APP_DIR}" || {
              echo "SSH mkdir failed for $ip - skipping host"
              continue
            }

            # rsync repo contents to remote dir (exclude .git and .github)
